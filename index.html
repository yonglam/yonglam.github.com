<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>No Fish</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="No Fish">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="No Fish">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="No Fish">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="No Fish" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">No Fish</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-加密-签名" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/04/加密-签名/" class="article-date">
  <time datetime="2016-02-04T12:27:39.000Z" itemprop="datePublished">2016-02-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/04/加密-签名/">加密&amp;签名</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>App需要使用的资源文件，一般都是从服务器下载下来。使用http协议或者socket长链接。这两种方式通过网络链路时都有可能被窃听、拦截、篡改。所以我们要对资源文件进行加密和签名。加密可以防止窃听，而签名可以确保来源正确从而防止篡改。</p>
<h1 id="加密">加密</h1><p>如果我们只是为了防止窃听，那对资源文件进行加密就可以了。这样，窃听者得到的数据是加密过的，在他无法解密的前提下，数据对他是无用的。</p>
<p><strong>1  最简单的对称加密</strong></p>
<p>客户端和服务器事先约定一个密钥。服务器用这个密钥加密数据，下发到客户端后，客户端用相同的密钥解密。客户端向服务器发送数据也类似。经典是AES算法。</p>
<p>这种方式简单易用，加解密速度快，而且密钥在双向通讯中都可以使用，但有两个缺点：一是密钥是写死在客户端中，反编译可以被获取到，从而被破解；二是更改密钥难度大，要客户端发版本。</p>
<p><strong>2  非对称加密</strong></p>
<p>客户端向服务器请求数据时：由客户端在运行时生成一对公私钥，然后把公钥发给服务器。服务器用公钥对数据进行加密，然后下发给客户端。客户端得到数据后，使用之前的私钥进行解密，得到数据。经典的算法有RSA、ECC。</p>
<p>服务器向客户端请求数据时也大体相同。</p>
<p>这种方式实现稍微复杂，加解密的时间成本也比较高，双向通讯时要维护两套密钥，但是客户端也不用写死密钥，安全级别高且机动灵活。有了效率起见，客户端也可以只是周期性地更新密钥。</p>
<p><strong>3  对称和非对称相结合</strong></p>
<p>对称加密效率高成本低，而非对称加密又灵活机动，如果两者相结合，取长补短，就能得到很好的效果。过程可以是：</p>
<ul>
<li>服务器生成公私钥(A、B)，把公钥B下发给客户端</li>
<li>客户端拿到公钥B后，生成一个对称密钥C，并用公钥B加密得到数据D</li>
<li>把数据D发给服务器，服务器拿到后，使用私钥A进行解密，得到密钥C</li>
<li>之后双方就可以通过对称密钥C进行通讯了</li>
</ul>
<h1 id="签名">签名</h1><p>对数据进行加密让窃听者无法得到有用的信息，但当我们得到数据之后，我们怎么确保得到的数据就是我们的服务器发送的。如果数据在通讯过程被人修改过、破坏过，或者是第三方伪造成我们的服务器直接向我们发送数据，怎么办？上面这两种情况都可以看成同一个问题：数据来源不正确。</p>
<p>这时就要用到电子签名。它的实现其实就是采用非称加密技术。</p>
<ul>
<li>首先，计算数据D的sha1（md5）；</li>
<li>其次，生成一对公私钥（公钥A、私钥B）；</li>
<li>接着，使用私钥B对sha1进行加密得到签名N；</li>
<li>接着，把数据D、签名N同公钥B一起发给客户端；</li>
<li>然后，客户端使用得到的公钥B对签名N进行解密得到sha1_new，同时计算数据D的sha1_old；</li>
<li>最后，对sha1_new和sha1_old作比较，如果相同则证明来源合法，否则不合法：有可能被篡改过或者第三方伪造我们的服务器直接发送的数据。</li>
</ul>
<h1 id="总结">总结</h1><p>加密保护数据不被偷窥，而签名保证数据是“对的人”发送的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/02/04/加密-签名/" data-id="cik899w6f00014qtrwi973i5m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Xcode-Plugin-Development" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/31/Xcode-Plugin-Development/" class="article-date">
  <time datetime="2016-01-31T07:00:00.000Z" itemprop="datePublished">2016-01-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/31/Xcode-Plugin-Development/">Xcode Plugin Development</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Xcode有一套完整的插件框架，但是Apple没有开放出来。所以现在的插件的实现方式，是使用函数替换的方式替换Xcode的私有库的函数，来定制自己的功能。私有库主要是DVKit和IDEKit。</p>
<p><strong>开发一个插件有如下过程：</strong></p>
<ul>
<li>首先，要明确需求，我们想做一个怎么样的功能，这个功能是否已经有类似的插件了？</li>
<li>其次，如果有类似插件，那最happy了，可以在这个插件的基础上开发我们的功能，那下面列到的大部分步骤你都不用涉及到。否则就要按下面的步骤自己开发。即使在这种情况下，最好还是在github上找一个插件模板，或者在原有插件项目中抽出来的框架，上开发。</li>
<li>再次，如果是自己开发，那就要看可能涉及到哪些xcode的逻辑、界面，然后利用下面的“前期准备”的方法来搜集相关素材。</li>
<li>接着，就是开发和调试了。</li>
<li>最后，写点脚本，发布给大家使用。</li>
</ul>
<h2 id="下面介绍重要环节的相关技术。">下面介绍重要环节的相关技术。</h2><h2 id="一、前期准备">一、前期准备</h2><p>这是最麻烦的过程。</p>
<p>1.监听Notification：</p>
<p>我们可以监听所有的Notification，从而获得</p>
<ul>
<li>用户操作的时机</li>
<li>操作的UI控件（debugDescription可以得到更多的界面信息）</li>
<li>操作的上下文</li>
</ul>
<p>2.Class-dump</p>
<p>对于UI控件和一些Model对象，可能通过<a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="external">class-dump</a>找到其所有的接口。github上已经有人dump了<a href="https://github.com/luisobo/Xcode-RuntimeHeaders" target="_blank" rel="external">Xcode所有的类</a>。</p>
<p>3.查看UI界面元素</p>
<p>Github上的<a href="https://github.com/edwardaux/XcodeExplorer" target="_blank" rel="external">XcodeExplorer</a>可以方便查看XcodeUI元素。  （我还没测试过。。。）</p>
<p>下面是在项目管理器上切换文件时收到的notification。<br><img src="/2016/01/31/Xcode-Plugin-Development/1.png" alt="image" title="image"></p>
<h2 id="二、构建设置">二、构建设置</h2><p>如果你找到了一个类似的项目，或者在插件模板上开发，那这些设置你需要修改的就很少了。<br>下面这张图中，重要的几个参数：</p>
<ul>
<li>DVTPluginCompatibilityUUIDs，一个字符串数组，所有支持的Xcode版本的UUID。</li>
<li>Principal class：字符串，插件的加载入口在这个类中。<img src="/2016/01/31/Xcode-Plugin-Development/2.png" alt="image" title="image">
</li>
</ul>
<h2 id="三、调试设置">三、调试设置</h2><p>这样设置之后，build成功就可以调起Xcode来进行调试了。<br><img src="/2016/01/31/Xcode-Plugin-Development/3.png" alt="image" title="image"><br><img src="/2016/01/31/Xcode-Plugin-Development/4.png" alt="image" title="image"></p>
<h2 id="四、开发">四、开发</h2><p>1  入口：这个类由plst中的Principal class来指定。建议采用单例模式。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> XCEPlugin *mySharedPlugin = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">+(<span class="keyword">void</span>)pluginDidLoad:(<span class="built_in">NSBundle</span> *)plugin &#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">	<span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">		mySharedPlugin = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+(XCEPlugin *)sharedPlugin &#123;</span><br><span class="line">	<span class="keyword">return</span> mySharedPlugin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>)init &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">		[<span class="keyword">self</span> addMenuItems];</span><br><span class="line">		[<span class="keyword">self</span> setNotificationsController:<span class="literal">nil</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2  举例1：弹窗口</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)viewClickerMenuClicked:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">	<span class="keyword">if</span> ([<span class="keyword">self</span> viewClickerController] == <span class="literal">nil</span>) &#123;</span><br><span class="line">		[<span class="keyword">self</span> setViewClickerController:[[XCEViewClickerWindowController alloc] init]];</span><br><span class="line">	&#125;</span><br><span class="line">	[[<span class="keyword">self</span> viewClickerController] showWindow:[<span class="built_in">NSApp</span> mainWindow]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3  举例2：获得文本编辑器</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">NSWindowController</span> *currentWindowController = [[<span class="built_in">NSApp</span> keyWindow] windowController]; </span><br><span class="line"><span class="keyword">if</span> ([currentWindowController isKindOfClass:<span class="built_in">NSClassFromString</span>(<span class="string">@"IDEWorkspaceWindowController"</span>)]) &#123; </span><br><span class="line"> IDEWorkspaceWindowController *workspaceController = (IDEWorkspaceWindowController *)currentWindowController; </span><br><span class="line"> IDEEditorArea *editorArea = [workspaceController editorArea]; </span><br><span class="line"> IDEEditorContext *editorContext = [editorArea lastActiveEditorContext]; </span><br><span class="line"> IDESourceCodeEditor *editor = [editorContext editor]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、发布配置（部署到当前插件目录）">五、发布配置（部署到当前插件目录）</h2><p>第2个红框，一起组成了部署路径： /Users/你的用户名/Library/Application\ Support/Developer/Shared/Xcode/Plug-ins<br><img src="/2016/01/31/Xcode-Plugin-Development/5.png" alt="image" title="image"></p>
<p>Reference:<br><a href="http://bits.citrusbyte.com/extending-xcode-6-with-plugins/" target="_blank" rel="external">http://bits.citrusbyte.com/extending-xcode-6-with-plugins/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/31/Xcode-Plugin-Development/" data-id="cik899w6k00044qtrprrp430o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Security-in-iOS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/27/Security-in-iOS/" class="article-date">
  <time datetime="2016-01-27T02:16:41.000Z" itemprop="datePublished">2016-01-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/27/Security-in-iOS/">Security in iOS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么要重视iOS安全">为什么要重视iOS安全</h2><p>在某种程度上，iOS 仍然算是一个多用户系统。与 UNIX 设计的环境不同，iOS 所有用户访问的账号和手机持有者所操作的账号是同一个。所有这些用户都是手机账号的持有者，包括手机上所装应用的开发者以及苹果。</p>
<p>这的确有点过于简单粗暴，毕竟许多应用的功能不止局限于开发者提交到应用商店的那些。SDK、远程分析服务以及开源组件意味着许多应用中实际上包含了来自多个机构的源码，并且必须通过网络进行通信就有潜在被监视的风险。游戏规则已经不再是保护不同的人彼此使用同一台计算机，而是保证同一个人的不同任务不会互相干扰。</p>
<p>在安全性方面的比较，往往我们认为iOS要优于安卓。苹果告诉我们每一个版本的 iOS 都比过去更安全，甚至公布了一份系统安全特性细则的白皮书。在其中苹果介绍它如何使用了不断更新的（希望是更加先进的）加密算法和协议，更健壮的鉴定表单以及其他技术。</p>
<p>但即使是最新版本的 iOS，拥有最新的工具和最新的编程语言，我们在其中所调用的方法，例如 C 语言的字符串库，也被认为在几十年前就需要被重构。操作系统只能提供适用任意应用的安全特性；但不能提供你的应用所需的一切。虽然苹果能告诉你，你的 app 连接到了一个提供了一些有效身份证明的服务器，但它不能告诉你这是否是一个值得你信任的身份。应用所接入的网络是否安全？它可能被监听了。</p>
<p>安全是你应用程序架构的一部分：它是一个约束集合，你必须像顾虑 app 的响应时间、客户群的规模或者是外部系统的兼容性那样来考虑安全的问题。这意味着你必须将安全模块设计到你的应用中，就像你设计应用时遵循的其他约束条件一样。</p>
<p>一个评估应用安全常用的设计技巧是风险建模 ：找到黑客们想要攻击你系统的原因，查出他们在使用现有的资源下的攻击方式，以及探索在系统设计中的可能被成功攻击的漏洞。</p>
<p>尽管软件安全技术和系统（比如 iOS）的安全保障能力一直在进步和创新，但风险分析和设计安全对策依然是应用开发者们的责任。<strong>那些使用我们应用时所产生的风险是不可能通过操作系统供应商或者框架开发人员解决的。</strong>这些风险是由应用所提供给用户的功能，或者在应用部署的环境或系统中所产生的。</p>
<p>以上引用自：<a href="http://objccn.io/issue-17-2/" target="_blank" rel="external">http://objccn.io/issue-17-2/</a></p>
<p><br><br>下面的几个议题，接下来会解读和补充上来。</p>
<h2 id="移动应用2015_top10安全问题">移动应用2015 top10安全问题</h2><p><a href="https://www.owasp.org/index.php/Projects/OWASP_Mobile_Security_Project_-2015_Scratchpad" target="_blank" rel="external">Mobile Security 2015</a></p>
<h2 id="iOS的代码签名和沙盒机制">iOS的代码签名和沙盒机制</h2><p><a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf" target="_blank" rel="external">iOS的安全白皮书</a></p>
<h2 id="iOS安全攻防">iOS安全攻防</h2><p><a href="http://wiki.jikexueyuan.com/project/ios-security-defense/" target="_blank" rel="external">攻与防</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/27/Security-in-iOS/" data-id="cik899w6800004qtrp5lqhuhi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用NSBlockOperation实现异步多任务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/18/使用NSBlockOperation实现异步多任务/" class="article-date">
  <time datetime="2016-01-17T16:17:00.000Z" itemprop="datePublished">2016-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/18/使用NSBlockOperation实现异步多任务/">使用NSBlockOperation实现异步多任务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上周五无意中看到有人使用<code>NSBlockOperation</code>来实现批量操作，觉得很是神奇！具体做法就是利用它可以添加多个block，并延后批量执行的特性，把每一个操作用一个block来封装，最后调用start运行。</p>
<p>一般的<code>NSOperation</code>只可执行一个操作，可以是同步的（默认）或者异步的（要实现一堆东西，github上有一个DRAsyncOperation的实现）任务。但<code>NSBlockOperation</code>是一个奇葩，可以<code>add</code>无数个<code>block</code>，而且最后<code>start</code>后这些<code>block</code>是分别异步完成的。如果想让它们同步执行，亲，你也得自己实现一个子类，重写<code>start</code>方法和其他相关方法。</p>
<p>使用<code>NSBlockOperation</code>来实现异步多任务有很多好处：</p>
<ul>
<li>轻量</li>
<li>可以设置依赖的任务（需要都加到同一个NSOperationQueue中）</li>
<li>可以设置完成所有任务后的回调<code>completionBlock</code> </li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)blockOperationTest</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *blockOperation = [[<span class="built_in">NSBlockOperation</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        [blockOperation addExecutionBlock:^&#123;</span><br><span class="line">            <span class="keyword">int</span> x = arc4random() % <span class="number">10</span>;</span><br><span class="line">            sleep(x);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@: %d , %d"</span>, [<span class="built_in">NSThread</span> currentThread], i, x);</span><br><span class="line">            </span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    blockOperation<span class="variable">.completionBlock</span> = ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"complete"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSOperation</span> *op = [[<span class="built_in">NSOperation</span> alloc] init];</span><br><span class="line">    [blockOperation addDependency:op];</span><br><span class="line">    [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperation:op];</span><br><span class="line">    [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperation:blockOperation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/18/使用NSBlockOperation实现异步多任务/" data-id="cik899w6h00024qtrvaeijz7x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Weak-Array-in-Obj-C" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/17/Weak-Array-in-Obj-C/" class="article-date">
  <time datetime="2016-01-17T13:34:23.000Z" itemprop="datePublished">2016-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/17/Weak-Array-in-Obj-C/">Weak Array in Obj-C</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>新年第一篇博文，献给No Fish.</p>
<p>微信的项目中，使用的是MVC的经典模式，但为了避免C变得臃肿，我们经常抽象出一个Logic层，它一般是被C所引用。Logic层有时会需要持有C，此时我们会定义C为<code>weak</code>的，避开循环引用。这可以满足大部分的场景。</p>
<p>但在微信支付中，使用了非经典的MVC，而是采用一个Logic会贯穿某个支付流程，Logic会持有一个数组，数组保存整个流程所有的ViewController。这个引发一个问题，ViewController在界面上消失之后，如果处理不当，就会一直被Logic所持有，最后泄露了。为了处理这个问题，我们需要一个弱引用的数组，它不会对存放于其中的对象的引用加1。</p>
<p>本来是想自己实现这个weak array。转念一想，就先到github上寻找，果然发现了几个实现。其中有一个提到了object-c自带的一个容器：<code>NSPointerArray</code>。它不但可以作为弱引用数组，而且还可以存放非oc对象。</p>
<p>一开始，我通过<code>new</code>生成<code>NSPointerArray</code>，实验之后发现它还是持有了它的元素。看了文档之后，才知道要使用它的类方法<code>weakObjectsPointerArray</code>生成实例。试了一把，效果一流。但是它的接口同<code>NSMutableArray</code>不太相同，在重构时不能直接替换，这个有点遗憾。有时间的话，可以简单封装一下，让它兼容<code>NSMutableArray</code>的接口，重构时就方便太多了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSPointerArray</span> *m_arrVC = [<span class="built_in">NSPointerArray</span> weakObjectsPointerArray];</span><br><span class="line">[m_arrVC addPointer:(<span class="keyword">void</span> * _Nullable)vc];</span><br></pre></td></tr></table></figure>
<p><code>NSPointerArray</code>还有一个问题，就是元素被释放之后，元素在数组中会被NULL被代换。所以Logic拿到的可能是一个<code>NULL</code>，虽然不会Crash，但业务逻辑可能会出错，支付的流程可能就此走不下去。怎么办？还在思考中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/17/Weak-Array-in-Obj-C/" data-id="cik899w7200054qtrz524o7ae" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/28/hello-world/" class="article-date">
  <time datetime="2015-08-28T12:49:46.000Z" itemprop="datePublished">2015-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/28/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/08/28/hello-world/" data-id="cik899w6j00034qtrsbzsbxho" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/02/04/加密-签名/">加密&amp;签名</a>
          </li>
        
          <li>
            <a href="/2016/01/31/Xcode-Plugin-Development/">Xcode Plugin Development</a>
          </li>
        
          <li>
            <a href="/2016/01/27/Security-in-iOS/">Security in iOS</a>
          </li>
        
          <li>
            <a href="/2016/01/18/使用NSBlockOperation实现异步多任务/">使用NSBlockOperation实现异步多任务</a>
          </li>
        
          <li>
            <a href="/2016/01/17/Weak-Array-in-Obj-C/">Weak Array in Obj-C</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Yong Lin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>